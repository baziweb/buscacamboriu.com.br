name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer, phpcs
        
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: /tmp/composer-cache
        key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
        
    - name: Install dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --prefer-dist --no-progress
        fi
        
    - name: Validate PHP syntax
      run: |
        find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" -exec php -l {} \; | tee php-lint.log
        if grep -q "Parse error" php-lint.log; then
          echo "âŒ Erros de sintaxe PHP encontrados!"
          exit 1
        else
          echo "âœ… Sintaxe PHP vÃ¡lida"
        fi
        
    - name: WordPress Coding Standards
      run: |
        if [ -f composer.json ] && [ -f vendor/bin/phpcs ]; then
          vendor/bin/phpcs --standard=WordPress --ignore=vendor/,node_modules/ --extensions=php .
        else
          echo "â„¹ï¸  PHPCS nÃ£o configurado, pulando verificaÃ§Ã£o de coding standards"
        fi
      continue-on-error: true
      
    - name: Security Check
      run: |
        echo "ğŸ” Verificando por padrÃµes de seguranÃ§a..."
        
        # Verificar se wp-config.php nÃ£o estÃ¡ sendo commitado
        if [ -f wp-config.php ]; then
          echo "âš ï¸  ATENÃ‡ÃƒO: wp-config.php encontrado no repositÃ³rio!"
          echo "Este arquivo nÃ£o deveria estar versionado por motivos de seguranÃ§a."
        fi
        
        # Verificar por credenciais hardcoded
        if grep -r -i "password\s*=" . --include="*.php" --exclude-dir=vendor --exclude-dir=node_modules; then
          echo "âš ï¸  ATENÃ‡ÃƒO: PossÃ­veis credenciais hardcoded encontradas!"
        fi
        
        # Verificar por debug habilitado
        if grep -r "WP_DEBUG.*true" . --include="*.php" --exclude-dir=vendor; then
          echo "âš ï¸  ATENÃ‡ÃƒO: WP_DEBUG habilitado encontrado!"
        fi
        
    - name: File Size Check
      run: |
        echo "ğŸ“Š Verificando tamanho dos arquivos..."
        find . -name "*.php" -o -name "*.js" -o -name "*.css" -o -name "*.jpg" -o -name "*.png" -o -name "*.gif" | \
        xargs ls -la | \
        awk '{if($5 > 1048576) print "âš ï¸  Arquivo grande (>1MB): " $9 " - " $5 " bytes"}'
        
    - name: Structure Validation
      run: |
        echo "ğŸ—ï¸  Validando estrutura do projeto..."
        
        # Verificar se Ã© um projeto WordPress vÃ¡lido
        if [ ! -f wp-load.php ] && [ ! -f index.php ]; then
          echo "âš ï¸  Este nÃ£o parece ser um projeto WordPress vÃ¡lido"
        fi
        
        # Verificar estrutura bÃ¡sica
        directories=("wp-content" "wp-admin" "wp-includes")
        for dir in "${directories[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… DiretÃ³rio encontrado: $dir"
          else
            echo "â„¹ï¸  DiretÃ³rio nÃ£o encontrado: $dir"
          fi
        done
        
    - name: PR Info
      run: |
        echo "ğŸ“‹ InformaÃ§Ãµes do Pull Request:"
        echo "- Branch origem: ${{ github.head_ref }}"
        echo "- Branch destino: ${{ github.base_ref }}"
        echo "- Autor: ${{ github.actor }}"
        echo "- Commit SHA: ${{ github.sha }}"
        
    - name: Comment PR
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const message = `
          ## ğŸ” ValidaÃ§Ã£o do PR
          
          âœ… **ValidaÃ§Ãµes executadas:**
          - Sintaxe PHP
          - Estrutura do projeto
          - VerificaÃ§Ã£o de seguranÃ§a
          - Tamanho de arquivos
          
          ğŸ“Š **Status:** ${{ job.status }}
          
          ğŸ”— **Logs completos:** [Ver na aba Actions](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})
          
          ---
          *ValidaÃ§Ã£o automÃ¡tica via GitHub Actions*
          `;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: message
          });
